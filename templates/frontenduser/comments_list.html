{% load static %}
<!-- comments -->
<div id="comments" class="comments">
    <h2 id="comments-list-title" class="comments-title h5 mx-1 my-4">
        <i class="iconfont icon-comment"></i>
        <span class="noticom">
            <a href="#respond" class="comments-title">评论</a>
        </span>
    </h2>
    <div class="card">
        <div class="card-body" id="comment-box">
            <div id="respond_box">
                <div id="respond" class="comment-respond">
                    <form class="text-sm mb-4" method="post"
                          enctype="multipart/form-data">
                        {% csrf_token %}

                        <div id="comment-author-info" class="row  row-sm">
                            <div class="visitor-avatar d-flex mb-2">
                                <img class="v-avatar rounded-circle"
                                     src="{% static 'favicon.ico' %}"
                                     alt="">
                            </div>
                            <div class="col-12 col-md-6 mb-3">
                                <a class="pixel-btn user_link_2 text-center" href=""
                                   onmouseout="default_href()" onmouseleave="default_href()"
                                   onmousemove="re_href_user('2')"
                                   style="display: block; cursor: pointer; width: 15rem;">
                                    VincentAdamNemessis
                                </a>
                            </div>
                        </div>
                        <div class="comment-textarea mb-3">
                            <label for="comment"></label><textarea name="comment" id="comment"
                                                                   class="form-control"
                                                                   placeholder="输入评论内容..."
                                                                   tabindex="4" cols="50"
                                                                   rows="5"></textarea>
                        </div>
                        <div class="com-footer d-flex justify-content-end flex-wrap">
                            <button class="btn btn-dark custom_btn-d ml-2">发表评论
                            </button>
                            <input type="hidden" name="action" value="publish">
                            <input type="hidden" name="comment_parent" id="comment_parent"
                                   value="0">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div><!-- comments end -->
<script>
	$(document).ready(function () {
		let comments_promise = get_comments_for_software_or_articles('{{ csrf_token }}', 'software', encrypt_param('{{ software.id }}'))
		comments_promise.then((data) => {
			let comments_list = '';
			if (data.length <= 0) {
				comments_list = `
            <div class="not-comment card">
                <div class="card-body nothing text-center color-d">暂无评论...</div>
            </div>
				`;
			} else {
				comments_list = `<ul class="comment-list">`;
				for (let index in data.comments) {
					if (data.comments[index].parent_id === encrypt_param('0')) {
						let comment = `
                        <li class="comment even thread-even depth-1 comment">
                            <div class="comment_body d-flex flex-fill">
                                <div class="profile mr-2 mr-md-3">
                                    <img src="${data.comments[index].user.head_icon}"
                                         width="96" height="96" alt="头像"
                                         class="avatar avatar-96wp-user-avatar wp-user-avatar-96 alignnone photo avatar-default">
                                </div>
                                <section class="comment-text d-flex flex-fill flex-column">
                                    <div class="comment-info d-flex align-items-center mb-1">
                                        <div class="comment-author text-sm w-100">
                                                <a    href='' class="user_link_${decrypt_param(data.comments[index].user.user_id.toString())}"
                                                        onmouseout="default_href()"
                                                        onmouseleave="default_href()"
                                                        onmousemove="re_href_user(decrypt_param('${data.comments[index].user.user_id}'))"
                                                        target="_blank"
                                                        rel="nofollow noopener noreferrer" class="url">${data.comments[index].user.username}</a>
                                                <span class="rank"
                                                                                           title="角色：${data.comments[index].user.role}">${data.comments[index].user.role}</span>
                                        </div>
                                    </div>
                                    <div class="comment-content d-inline-block text-sm">
                                        <p>${data.comments[index].content}</p>
                                    </div>
                                    <div class="d-flex flex-fill text-xs text-muted pt-2">
                                        <div class="comment-meta">
                                            <span class="info mr-2"><i
                                                    class="iconfont icon-time mr-1"></i><time
                                                    itemprop="datePublished"
                                                    datetime="${data.comments[index].created_time}"></time>
                                            </span>
                                        </div>
                                        <div class="flex-fill"></div>
                                        <a rel="nofollow" class="comment-reply-link" href="#respond"
                                           data-commentid="4" data-postid="93"
                                           onclick=""
                                           data-belowelement="comment-4" data-respondelement="respond"
                                           data-replyto="回复给xx" aria-label="回复给xx">回复</a></div>
                                </section>
                            </div>
                        `;
						comment += load_children(data, data.comments[index].comment_id.toString());
                        comment += '</li><!-- #comment-## -->';
						comments_list += comment;
					}
				}
				comments_list += '</ul>';
			}
			document.getElementById('comment-box').innerHTML += comments_list;
			format_time_block();
		})
	})
	
	function load_children(data, id) {
		let children_list = '<ul class="children">';
		for (let index in data.comments) {
			if (data.comments[index].parent_id === id && data.comments[index].comment_id !== id) {
				children_list += `
                        <li class="comment byuser bypostauthor odd alt depth-2 comment">
                            <div class="comment_body d-flex flex-fill">
                                <div class="profile mr-2 mr-md-3">
                                    <img src="${data.comments[index].user.head_icon}"
                                         width="96" height="96" alt="头像"
                                         class="avatar avatar-96wp-user-avatar wp-user-avatar-96 alignnone photo avatar-default">
                                </div>
                                <section class="comment-text d-flex flex-fill flex-column">
                                    <div class="comment-info d-flex align-items-center mb-1">
                                        <div class="comment-author text-sm w-100">
                                                <a    href='' class="user_link_${decrypt_param(data.comments[index].user.user_id.toString())}"
                                                        onmouseout="default_href()"
                                                        onmouseleave="default_href()"
                                                        onmousemove="re_href_user(decrypt_param('${data.comments[index].user.user_id}'))"
                                                        target="_blank"
                                                        rel="nofollow noopener noreferrer" class="url">${data.comments[index].user.username}</a>
                                                <span class="rank"
                                                          title="角色：${data.comments[index].user.role}">${data.comments[index].user.role}</span>
                                        </div>
                                    </div>
                                    <div class="comment-content d-inline-block text-sm">
                                        <p>${data.comments[index].content}</p>
                                    </div>
                                    <div class="d-flex flex-fill text-xs text-muted pt-2">
                                        <div class="comment-meta">
                                            <span class="info mr-2"><i
                                                    class="iconfont icon-time mr-1"></i><time
                                                    itemprop="datePublished"
                                                    datetime="${data.comments[index].created_time}"></time>
                                            </span>
                                        </div>
                                        <div class="flex-fill"></div>
                                    </div>
                                </section>
                            </div>
                        </li><!-- #comment-## -->
				`;
			}
		}
		children_list += '</ul><!-- .children -->';
		return children_list;
	}
</script>