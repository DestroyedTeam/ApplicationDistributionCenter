{% extends 'frontenduser/base.html' %}
{% load static %}
{% block title %}
    投稿软件
{% endblock %}
{% block meta %}
    <meta name="keywords" content="">
    <meta name="description" content="">
{% endblock %}
{% block style %}
    <style>
        @media (min-width: 768px) {
            .content-layout {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                width: 100%;
            }

            .content-layout .panel {
                width: 60%;
            }

            .content-layout .sidebar {
                width: 38% !important;
                float: none !important;
                margin-left: unset !important;
            }
        }

        .screenshots_area {
            display: flex;
            flex-direction: row;
            justify-content: normal;
            column-gap: 1rem;
        }

        .publish-form img {
            max-width: 100%;
        }

        .notice-msg {
            text-align: left;
        }
    </style>
{% endblock %}
{% block content %}
    <div class="loading_container">
        <div class="loading"><i></i><i></i><i></i><i></i></div>
    </div>
    <body class="page-template page-template-template-contribute page-template-template-contribute-php page page-id-31 sidebar_right">
    {% include 'frontenduser/sidebar.html' %}
    <div class="main-content flex-fill">
        {% include 'frontenduser/header-nav.html' %}
        <div id="content" class="container my-4 my-md-5">
            <h1 id="comments-list-title" class="comments-title h5 mx-1 my-4">
                <i class="iconfont icon-tishi mr-2"></i>投稿须知
            </h1>
            <div class="panel card">
                <div class="card-body">
                    <div class="panel-body single mt-2" style="text-indent: 2em" id="notice">
                        这是一个Mac软件分享平台，欢迎开发者或用户分享各种类型和功能的Mac软件。
                        投稿软件必须合法、无违法内容，经过充分测试，提供清晰的安装和使用说明，注
                        明基本信息并上传至网站。审核通过后，软件将发布在平台上。沟通保持畅通，开
                        发者需提供支持和更新。感谢对网站的支持和贡献，期待更多优秀作品的出现！
                    </div>
                </div>
            </div>
            <div class="text-center mb-3">
                <div class="tab-btn-group text-lg">
                    <a href="/commentswitharticles/publish?type=1" onclick="switch_tab(1);"
                       class="tab-btn active" id="article-btn">新文章</a>
                    <a href="/commentswitharticles/publish?type=2" onclick="switch_tab(2);"
                       class="tab-btn" id="app-btn">新软件</a>
                </div>
            </div>
            <form action="/software/publish/" onsubmit="return validate_form();"
                  class="post-tg publish-form" enctype="multipart/form-data"
                  method="post">
                {% csrf_token %}
                <div class="content-wrap">
                    <div class="content-layout">
                        <div class="panel card">
                            <div class="card-body">
                                <div class="my-2">
                                    <label for="icon">图标:</label>
                                    <div class="upload_img">
                                        <div class="show_ico">
                                            <img id="show_ico"
                                                 src="{% static 'front/img/publication/add.png' %}"
                                                 alt="图标">
                                            <i id="remove_ico"
                                               class="iconfont icon-close-circle remove-ico remove-sites"
                                               style="display: none;" onclick="remove_img(1)"></i>
                                        </div>
                                        <input type="file" id="icon" name="icon"
                                               accept="image/*" onchange="preview_img(1)">
                                    </div>
                                </div>
                                <div class="screenshots_area">
                                    <label for="software_screenshots" style="margin-top: 4.5%">软件截图:</label>
                                    <input type="hidden" value="" id="software_screenshots"
                                           name="software_screenshots">
                                    <div class="upload_img">
                                        <div class="show_ico">
                                            <img id="show_ico" class="show-sites"
                                                 src="{% static 'front/img/publication/add.png' %}"
                                                 alt="截图">
                                            <i id="remove_ico"
                                               class="iconfont icon-close-circle remove-ico remove-sites"
                                               style="display: none;" onclick="remove_img(2)"></i>
                                        </div>
                                        <input type="file"
                                               name="software_screenshot_1" accept="image/*"
                                               onchange="preview_img(2)">
                                    </div>
                                    <div class="upload_img" style="display: none">
                                        <div class="show_ico">
                                            <img id="show_ico" class="show-sites"
                                                 src="{% static 'front/img/publication/add.png' %}"
                                                 alt="截图">
                                            <i id="remove_ico"
                                               class="iconfont icon-close-circle remove-ico remove-sites"
                                               style="display: none;" onclick="remove_img(2)"></i>
                                        </div>
                                        <input type="file"
                                               name="software_screenshot_2" accept="image/*"
                                               onchange="preview_img(2)">
                                    </div>
                                    <div class="upload_img" style="display: none">
                                        <div class="show_ico">
                                            <img id="show_ico" class="show-sites"
                                                 src="{% static 'front/img/publication/add.png' %}"
                                                 alt="截图">
                                            <i id="remove_ico"
                                               class="iconfont icon-close-circle remove-ico remove-sites"
                                               style="display: none;" onclick="remove_img(2)"></i>
                                        </div>
                                        <input type="file"
                                               name="software_screenshot_3" accept="image/*"
                                               onchange="preview_img(2)">
                                    </div>
                                    <div class="upload_img" style="display: none">
                                        <div class="show_ico">
                                            <img id="show_ico" class="show-sites"
                                                 src="{% static 'front/img/publication/add.png' %}"
                                                 alt="截图">
                                            <i id="remove_ico"
                                               class="iconfont icon-close-circle remove-ico remove-sites"
                                               style="display: none;" onclick="remove_img(2)"></i>
                                        </div>
                                        <input type="file"
                                               name="software_screenshot_4" accept="image/*"
                                               onchange="preview_img(2)">
                                    </div>
                                    <div class="upload_img" style="display: none">
                                        <div class="show_ico">
                                            <img id="show_ico" class="show-sites"
                                                 src="{% static 'front/img/publication/add.png' %}"
                                                 alt="截图">
                                            <i id="remove_ico"
                                               class="iconfont icon-close-circle remove-ico remove-sites"
                                               style="display: none;" onclick="remove_img(2)"></i>
                                        </div>
                                        <input type="file"
                                               name="software_screenshot_5" accept="image/*"
                                               onchange="preview_img(2)">
                                    </div>
                                </div>
                                <div class="row row-sm">
                                    <div class="col-12 my-2">
                                        <div class="input-group count-tips" data-min="0" data-max="50">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="iconfont icon-name icon-fw"
                                                                                  aria-hidden="true"></i></span>
                                            </div>
                                            <input type="text" class="form-control sites-title" value=""
                                                   name="name" placeholder="软件名" maxlength="50"
                                                   oninput="update_tips()">
                                        </div>
                                    </div>
                                    <div class="col-12 my-2">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">
                                                    <i class="fa fa-code-fork icon-fw" aria-hidden="true"></i>
                                                </span>
                                            </div>
                                            <input type="text" class="form-control sites-title" value=""
                                                   name="version" placeholder="版本号" maxlength="30">
                                        </div>
                                    </div>
                                    <div class="col-12 my-2">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">
                                                    <i class="fa fa-globe icon-fw" aria-hidden="true"></i>
                                                </span>
                                            </div>
                                            <select class="form-control" name="language">
                                                <option value="多语言">多语言</option>
                                                <option value="中文">中文</option>
                                                <option value="英文">英文</option>
                                                <option value="日文">日文</option>
                                                <option value="韩文">韩文</option>
                                                <option value="其他">其他</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-12 my-2">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">
                                                    <i class="fa fa-laptop icon-fw"
                                                       aria-hidden="true"></i></span>
                                            </div>
                                            <select name="platform" class="form-control">
                                                <option value="Mac">Mac</option>
                                                <option value="Windows">Windows</option>
                                                <option value="Linux">Linux</option>
                                                <option value="Android">Android</option>
                                                <option value="iOS">iOS</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-12 my-2">
                                        <div class="input-group count-tips" data-min="0" data-max="100">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">
                                                    <i class="fa fa-apple icon-fw" aria-hidden="true"></i>
                                                </span>
                                            </div>
                                            <input type="text" class="form-control sites-title" value=""
                                                   name="run_os_version" placeholder="支持系统版本（英文;分隔）"
                                                   maxlength="100" oninput="update_tips()">
                                        </div>
                                    </div>
                                    <div class="col-12 my-2">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">
                                                    <svg t="1709660489436" class="icon icon-fw icon-fw-append"
                                                         viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5082" width="200" height="200"><path d="M672 64l224 219.008V896a64 64 0 0 1-64 64H192a64 64 0 0 1-64-64V128a64 64 0 0 1 64-64h480z m-96 64H192v768h640V352h-128a128 128 0 0 1-128-128V128z m233.568 160l-163.648-160H640v96a64 64 0 0 0 64 64h105.568z" fill="#3C414B" p-id="5083"></path><path d="M375.872 576v27.168H291.936l-4.928 51.68h0.736c5.408-5.792 11.648-10.016 18.72-12.672 6.4-2.624 13.536-3.968 21.408-3.968 16.576 0 30.016 5.792 40.384 17.408 10.496 11.776 15.744 27.776 15.744 48 0 19.328-6.88 35.264-20.672 47.744-12.8 11.072-27.904 16.608-45.28 16.608-15.904 0-29.632-4.672-41.12-13.984-12.64-10.208-19.616-24.096-20.928-41.664h28.32c1.312 10.368 5.088 18.016 11.328 22.944 5.568 4.384 13.12 6.592 22.656 6.592 10.496 0 19.296-3.424 26.336-10.272 7.04-7.04 10.592-16.256 10.592-27.68 0-12.48-3.04-22.432-9.12-29.792-5.728-7.2-14.432-10.816-26.08-10.816a41.28 41.28 0 0 0-19.68 4.224 33.6 33.6 0 0 0-14.272 14.496h-26.816l9.6-106.016h107.072zM480 576c20.448 0 36.384 8.96 47.808 26.912 10.784 17.088 16.192 40.096 16.192 69.088s-5.408 52-16.192 69.088c-11.616 17.952-27.552 26.912-47.808 26.912-20.608 0-36.544-8.96-47.808-26.912C421.408 724 416 700.992 416 672s5.408-52 16.192-69.088C443.296 584.96 459.232 576 480 576z m130.464 0l61.152 150.592h0.992L733.504 576h34.464v192h-29.44v-132.288h-0.992L684.704 768h-25.408l-52.832-132.288h-0.992V768h-29.44v-192h34.464zM480 608c-12.736 0-21.632 7.456-26.656 22.368-3.552 10.048-5.344 23.936-5.344 41.632 0 17.408 1.792 31.296 5.344 41.632 5.184 14.912 14.08 22.368 26.656 22.368 12.448 0 21.344-7.456 26.656-22.368 3.552-10.368 5.344-24.224 5.344-41.632 0-17.728-1.792-31.616-5.344-41.632-5.344-14.912-14.208-22.368-26.656-22.368z" fill="#F8D61D" p-id="5084"></path></svg>
                                                </span>
                                            </div>
                                            <input type="text" class="form-control sites-title" value=""
                                                   name="file_size" placeholder="文件大小（单位：MB/KB/GB）"
                                                   maxlength="30">
                                        </div>
                                    </div>
                                    <div class="col-12 my-2">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">
                                                    <i class="iconfont icon-url icon-fw"
                                                       aria-hidden="true"></i></span>
                                            </div>
                                            <input type="url" class="form-control sites-title" value=""
                                                   name="official_link" placeholder="官方链接" maxlength="50">
                                        </div>
                                    </div>
                                    <div class="col-12 my-2">
                                        <textarea class="form-control text-sm" rows="8" cols="55"
                                                  name="description" placeholder="软件描述"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="sidebar show-sidebar">
                            <div class="card rounded-lg mb-3 relative">
                                <div class="card-header widget-header">
                                    <h3 class="text-md mb-0"><i class="iconfont icon-publish mr-2"></i>投稿选项</h3>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted text-sm mb-2">分类</p>
                                    <div class="form-select">
                                        <select name="category" id="post_cat" class="form-control">
                                            <option value="0" selected="selected">选择分类</option>
                                            {% for category in request.categories %}
                                                <option class="level-0"
                                                        value="{{ category.id }}">{{ category.name }}</option>
                                            {% endfor %}
                                        </select>
                                        <p class="text-muted text-sm mb-2 mt-3">标签（英文;分隔）</p>
                                        <input type="text" class="form-control"
                                               name="tags" placeholder="软件的标签">
                                    </div>
                                </div>
                            </div>
                            <div class="card rounded-lg mb-3 relative">
                                <div class="card-header widget-header">
                                    <h3 class="text-md mb-0"><i class="iconfont icon-publish mr-2"></i>下载链接</h3>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted text-sm mb-2">阿里云盘</p>
                                    <div class="mb20">
                                        <input type="url" class="form-control"
                                               name="link_adrive" placeholder="阿里云盘下载链接">
                                    </div>
                                    <p class="text-muted text-sm mb-2 mt-3">百度云盘</p>
                                    <input type="url" class="form-control"
                                           name="link_baidu" placeholder="百度云盘下载链接">
                                    <p class="text-muted text-sm mb-2 mt-3">123云盘</p>
                                    <input type="url" class="form-control"
                                           name="link_123" placeholder="123云盘下载链接">
                                </div>
                            </div>
                            <input type="hidden" name="action" value="app">
                            <div class="card rounded-lg relative">
                                <div class="card-body">
                                    <button type="submit" id="submit"
                                            class="btn btn-danger custom_btn-d text-sm col-12 custom-submit"><i
                                            class="iconfont icon-upload-wd mr-2"></i>提交审核
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </form>
        </div>
    </div><!-- main-content end -->
    </body>
{% endblock %}
{% block script %}
    <script>
		$(document).ready(function () {
			switch_tab(2);
		})
		
		function switch_tab(type) {
			if (type === 1) {
				document.querySelector('#app-btn').classList.remove('active');
				document.querySelector('#article-btn').classList.add('active');
			} else if (type === 2) {
				document.querySelector('#article-btn').classList.remove('active');
				document.querySelector('#app-btn').classList.add('active');
			}
		}
		
		function update_tips() {
			let tg = event.target;
			let tips = tg.parentElement;
			let count = tg.value.length;
			tips.setAttribute('data-min', count);
		}
		
		function preview_img(type = 1) {
			let tg = event.target;
			let file = tg.files[0];
			let reader = new FileReader();
			if (type === 1) {
				reader.onloadend = function () {
					tg.parentElement.children[0].children[0].src = reader.result;
					tg.parentElement.children[0].children[1].setAttribute('style', 'display: block');
				};
			} else if (type === 2) {
				let next_sibling = tg.parentElement.nextElementSibling;
				reader.onloadend = function () {
					tg.parentElement.children[0].children[0].src = reader.result;
					tg.parentElement.children[0].children[1].setAttribute('style', 'display: block');
					next_sibling.style = 'display: block';
				};
			}
			reader.readAsDataURL(file);
		}
		
		function remove_img(type = 1) {
			let tg = event.target;
			if (type === 1) {
				tg.parentElement.children[0].src = '{% static 'front/img/publication/add.png' %}';
				tg.setAttribute('style', 'display: none');
			} else if (type === 2) {
				tg.parentElement.parentElement.children[1].value = null;
				tg.parentElement.parentElement.style = 'display: none';
			}
		}
		
		function validate_form() {
			let name = document.querySelector('input[name="name"]').value;
			let version = document.querySelector('input[name="version"]').value;
			let language = document.querySelector('select[name="language"]').value;
			let platform = document.querySelector('select[name="platform"]').value;
			let run_os_version = document.querySelector('input[name="run_os_version"]').value;
			let file_size = document.querySelector('input[name="file_size"]').value;
			let official_link = document.querySelector('input[name="official_link"]').value;
			let description = document.querySelector('textarea[name="description"]').value;
			let category = document.querySelector('select[name="category"]').value;
			let tags = document.querySelector('input[name="tags"]').value;
			let link_adrive = document.querySelector('input[name="link_adrive"]').value;
			let link_baidu = document.querySelector('input[name="link_baidu"]').value;
			let link_123 = document.querySelector('input[name="link_123"]').value;
			let msg = [];
			//check icon file upload
			if (document.querySelector('input[name="icon"]').files.length < 1) {
				msg.push('请上传软件图标！');
			}
			//check at least one screenshot upload
			let count = 0;
			for (let i = 1; i <= 5; i++) {
				if (document.querySelector('input[name="software_screenshot_' + i + '"]').files.length >= 1) {
					if (document.querySelector('input[name="software_screenshot_' + i + '"]').files[0] !== null) {
						count++;
					}
				}
			}
			if (count < 2) {
				msg.push('请至少上传两张软件截图！');
			}
			console.log(count);
			//check software name
			if (!/^[\u4e00-\u9fa5A-Za-z0-9\s]{1,50}$/.test(name)) {
				msg.push('软件名格式错误，要求为长度不超过50个字符的中文、英文、数字和空格！');
			}
			//check version
			if (!/^(?!.{31,})\d+\.\d+(?:\.\d+)*$/.test(version)) {
				msg.push('版本号格式错误，要求为长度不超过30个字符的数字和英文点号！');
			}
			//check language
			if (!/^(多语言|中文|英文|韩文|日文|其他)$/.test(language)) {
				msg.push('请选择正确的软件语言！');
			}
			//check platform
			if (!/^(Mac|Windows|Linux|Android|iOS)$/.test(platform)) {
				msg.push('请选择正确的软件平台！');
			}
			//check run os version
			if (!/^[A-Za-z0-9.\s;]{1,100}$/.test(run_os_version)) {
				msg.push('支持系统版本格式错误，要求为长度不超过100个字符的英文、数字、空格、英文点号和分号！');
			}
			//check file size
			if (!/^(?!.{31,})\d+(\.\d+)?\s?(MB|KB|GB)$/.test(file_size)) {
				msg.push('文件大小格式错误，要求为长度不超过30个字符的数字、英文点号和单位MB/KB/GB！');
			}
			//check official link
			if (!/^(http|https):\/\/[a-zA-Z0-9\-.]+\.[a-zA-Z]{2,3}(\/\S*)?$/.test(official_link)) {
				msg.push('官方链接格式错误，要求为正确的网址！');
			}
			//check description
			if (!/[\u4e00-\u9fa5A-Za-z0-9\s，。？！；：“”‘’（）《》【】—…`~!@#$%^&*()_\-+=<>?:\"{}|,.\/;'\\[\]·~！@#￥%……&*（）——\-+=《》？：“”【】、；‘'，。、]{3,1000}/.test(description)) {
				msg.push('软件描述格式错误，要求为长度不超过1000个字符的中文、英文、数字和标点符号及其他特殊字符！');
			}
			//check category
			if (!/^\d{1,5}$/.test(category)) {
				msg.push('请选择正确的软件分类！');
			}
			//check tags
			if (!/^([A-Za-z0-9\s;\u4e00-\u9fa5]{1,100})?$/.test(tags)) {
				msg.push('软件标签格式错误，要求为长度不超过100个字符的英文、数字、空格和英文分号！');
			}
			//check link adrive
			if (!/^(https:\/\/www\.aliyundrive\.com\/\S*)?$/.test(link_adrive)) {
				msg.push('阿里云盘下载链接格式错误，要求为正确的阿里云盘分享链接！');
			}
			//check link baidu
			if (!/^(https:\/\/pan\.baidu\.com\/\S*)?$/.test(link_baidu)) {
				msg.push('百度云盘下载链接格式错误，要求为正确百度云盘的分享链接！');
			}
			//check link 123
			if (!/^(https:\/\/www\.123yunpan\.com\/\S*)?$/.test(link_123)) {
				msg.push('123云盘下载链接格式错误，要求为正确的123云盘分享链接！');
			}
			//check all links
			if (link_adrive.length < 1 && link_baidu.length < 1 && link_123.length < 1) {
				msg.push('请至少填写一个下载链接！');
			}
			if (msg.length > 0) {
				let msg_str = '<ul class="notice-msg">';
				for (let i = 0; i < msg.length; i++) {
					msg_str += "<li>" + msg[i] + '</li>';
				}
				msg_str += '</ul>';
				Swal.fire({
					icon: 'error',
					title: '请检查填写信息',
					html: msg_str,
					showConfirmButton: true,
					confirmButtonText: '我知道了'
				});
				return false;
			}
			return true;
		}
    </script>
{% endblock %}
